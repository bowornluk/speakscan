<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเช็คชื่อด้วยใบหน้า V3 (สมบูรณ์)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #video-container { position: relative; }
        #video, #canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
        #camera-placeholder svg, #dashboard-placeholder svg { width: 80px; height: 80px; color: #9ca3af; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn-active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="config-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">ตั้งค่า Google Web App URL</h2>
            <p class="mb-4 text-gray-600">กรุณานำ URL ของ Web App ที่ได้จากการ Deploy Google Apps Script มาใส่ที่นี่</p>
            <input type="url" id="web-app-url-input" class="w-full p-2 border rounded-md mb-4" placeholder="https://script.google.com/macros/s/...">
            <button id="save-config-btn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">บันทึก</button>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h1 class="text-3xl font-bold text-blue-600">ระบบเช็คชื่อด้วยใบหน้า</h1>
                <div class="flex items-center space-x-2 bg-gray-200 p-1 rounded-full">
                    <button id="tab-scan" class="tab-btn px-4 py-2 rounded-full text-sm font-medium">สแกน</button>
                    <button id="tab-dashboard" class="tab-btn px-4 py-2 rounded-full text-sm font-medium">แดชบอร์ด</button>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="manage-data-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">จัดการข้อมูล</button>
                    <button id="reset-config-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 text-sm">Reset URL</button>
                </div>
            </div>
        </header>
        <main>
            <!-- Scan View -->
            <div id="scan-view">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">สแกนใบหน้าเพื่อเช็คชื่อ</h2>
                    <div id="video-container" class="w-full max-w-2xl mx-auto aspect-video bg-gray-900 rounded-lg overflow-hidden mb-4 shadow-inner relative flex items-center justify-center">
                        <div id="camera-placeholder" class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                            <p class="text-gray-400 mt-2">กด "เริ่มสแกน" เพื่อเปิดกล้อง</p>
                        </div>
                        <div id="status-indicator" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm z-10 hidden"></div>
                        <video id="video" width="720" height="560" autoplay muted class="hidden"></video>
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="text-center mb-4"><button id="toggle-scan-btn" class="bg-blue-600 text-white px-8 py-3 rounded-full hover:bg-blue-700 text-lg font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">เริ่มสแกน</button></div>
                    <div id="scan-log" class="mt-4 p-4 bg-gray-50 rounded-lg h-48 overflow-y-auto border"><p class="text-gray-500">ผลการสแกนจะแสดงที่นี่...</p></div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                         <h2 class="text-2xl font-bold">สรุปผลการเข้าเรียน</h2>
                         <div class="flex items-center gap-4">
                            <select id="period-filter" class="border rounded-md p-2">
                                <option value="day">รายวัน</option>
                                <option value="week">รายสัปดาห์</option>
                                <option value="month">รายเดือน</option>
                                <option value="year">รายปี</option>
                            </select>
                            <input type="date" id="dashboard-date" class="border rounded-md p-2">
                         </div>
                    </div>
                    <div id="dashboard-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- Student cards will be inserted here -->
                    </div>
                     <div id="dashboard-placeholder" class="text-center py-16 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                         <p id="dashboard-placeholder-text" class="text-gray-500 mt-4 text-lg">ไม่พบข้อมูลการเข้าเรียนในช่วงเวลาที่เลือก</p>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="student-list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">จัดการข้อมูลนักเรียน</h2><button id="add-student-btn" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600">เพิ่มนักเรียนใหม่</button></div><div class="overflow-y-auto flex-grow"><table class="w-full text-left"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">รหัสนักเรียน</th><th class="p-3">ชื่อ-สกุล</th><th class="p-3">ชั้น</th><th class="p-3">จัดการ</th></tr></thead><tbody id="student-table-body"></tbody></table></div><div class="mt-6 text-right"><button id="close-list-modal-btn" class="bg-gray-300 px-6 py-2 rounded-md">ปิด</button></div></div></div>
    <div id="student-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-[60] hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg"><h2 id="modal-title" class="text-2xl font-bold mb-6">เพิ่มข้อมูลนักเรียน</h2><form id="student-form"><input type="hidden" id="student-row-index"><div class="mb-4"><label for="student-id" class="block mb-2 font-semibold">รหัสนักเรียน</label><input type="text" id="student-id" class="w-full p-2 border rounded-md" required></div><div class="mb-4"><label for="student-name" class="block mb-2 font-semibold">ชื่อ-สกุล</label><input type="text" id="student-name" class="w-full p-2 border rounded-md" required></div><div class="mb-4"><label for="student-class" class="block mb-2 font-semibold">ชั้น</label><input type="text" id="student-class" class="w-full p-2 border rounded-md" required></div><div class="mb-6"><label for="student-image" class="block mb-2 font-semibold">อัปโหลดรูปภาพใบหน้า</label><input type="file" id="student-image" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><p class="text-sm text-gray-500 mt-1">สำคัญ: รูปถ่ายหน้าตรง ไม่สวมแว่นตาหรือหมวก</p></div><div class="flex justify-end space-x-4"><button type="button" id="cancel-btn" class="bg-gray-300 px-6 py-2 rounded-md">ยกเลิก</button><button type="submit" id="save-student-btn" class="bg-blue-500 text-white px-6 py-2 rounded-md">บันทึก</button></div></form></div></div>
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-[100] hidden"><div class="loader w-16 h-16 rounded-full border-4 border-gray-200"></div><p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">กำลังโหลด...</p></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONFIG ---
    let WEB_APP_URL = '';
    const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
    let faceMatcher = null;
    let studentsData = [];
    let allAttendanceData = [];
    let checkInInterval = null;
    const checkedInToday = new Set();
    let isScanningPaused = false;
    let isCameraActive = false;
    
    // --- DOM ELEMENTS ---
    const appContainer = document.getElementById('app-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const toggleScanBtn = document.getElementById('toggle-scan-btn');
    const scanView = document.getElementById('scan-view');
    const dashboardView = document.getElementById('dashboard-view');
    const tabScan = document.getElementById('tab-scan');
    const tabDashboard = document.getElementById('tab-dashboard');
    const dashboardDateInput = document.getElementById('dashboard-date');
    const periodFilter = document.getElementById('period-filter');

    // --- UTILITY FUNCTIONS ---
    const showLoading = (text = 'กำลังโหลด...') => { loadingText.innerText = text; loadingOverlay.classList.remove('hidden'); };
    const hideLoading = () => loadingOverlay.classList.add('hidden');
    function speak(text) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'th-TH'; utterance.rate = 0.9; window.speechSynthesis.speak(utterance); } }
    
    // --- API CALL ---
    async function callGoogleScript(action, payload = {}) {
        try {
            const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action, payload }) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result.data;
        } catch (error) {
            Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถเชื่อมต่อ Google Sheet: ${error.message}.`, 'error');
            hideLoading();
            return null;
        }
    }

    // --- TAB SWITCHING ---
    function switchTab(tabName) {
        if (tabName === 'scan') {
            scanView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            tabScan.classList.add('tab-btn-active');
            tabDashboard.classList.remove('tab-btn-active');
        } else if (tabName === 'dashboard') {
            scanView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            tabScan.classList.remove('tab-btn-active');
            tabDashboard.classList.add('tab-btn-active');
            stopScanning();
            renderDashboard();
        }
    }
    tabScan.addEventListener('click', () => switchTab('scan'));
    tabDashboard.addEventListener('click', () => switchTab('dashboard'));

    // --- DASHBOARD LOGIC ---
    dashboardDateInput.addEventListener('change', renderDashboard);
    periodFilter.addEventListener('change', renderDashboard);

    function renderDashboard() {
        const selectedDate = new Date(dashboardDateInput.value);
        const period = periodFilter.value;
        const grid = document.getElementById('dashboard-grid');
        const placeholder = document.getElementById('dashboard-placeholder');
        grid.innerHTML = '';

        let periodLabel = '';
        let dailyAttendance = [];
        let periodCounts = {};

        const allAttendanceWithDates = allAttendanceData.map(att => ({...att, date: new Date(att.timestamp)}));

        if (period === 'day') {
            periodLabel = 'วันนี้';
            const selectedDateString = selectedDate.toDateString();
            dailyAttendance = allAttendanceWithDates.filter(att => att.date.toDateString() === selectedDateString);
        } else if (period === 'week') {
            periodLabel = 'สัปดาห์นี้';
            const startOfWeek = new Date(selectedDate);
            startOfWeek.setDate(selectedDate.getDate() - selectedDate.getDay());
            startOfWeek.setHours(0,0,0,0);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23,59,59,999);
            dailyAttendance = allAttendanceWithDates.filter(att => att.date >= startOfWeek && att.date <= endOfWeek);
        } else if (period === 'month') {
            periodLabel = 'เดือนนี้';
            const currentMonth = selectedDate.getMonth();
            const currentYear = selectedDate.getFullYear();
            dailyAttendance = allAttendanceWithDates.filter(att => att.date.getMonth() === currentMonth && att.date.getFullYear() === currentYear);
        } else if (period === 'year') {
            periodLabel = 'ปีนี้';
            const currentYear = selectedDate.getFullYear();
            dailyAttendance = allAttendanceWithDates.filter(att => att.date.getFullYear() === currentYear);
        }
        
        periodCounts = dailyAttendance.reduce((acc, att) => {
            acc[att.id] = (acc[att.id] || 0) + 1;
            return acc;
        }, {});
        
        const uniqueDailyStudentIds = [...new Set(dailyAttendance.map(att => att.id))];
        
        if (uniqueDailyStudentIds.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');
        
        uniqueDailyStudentIds.forEach(studentId => {
            const student = studentsData.find(s => String(s.id) === String(studentId));
            if (!student) return;

            const card = document.createElement('div');
            card.className = "bg-gray-50 rounded-lg p-4 text-center shadow transition hover:shadow-lg";
            // **FIX:** Use student.imageData for the image source
            card.innerHTML = `
                <img src="${student.imageData || 'https://placehold.co/150x150/e2e8f0/475569?text=No+Image'}" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-white shadow-md">
                <h3 class="font-bold text-lg">${student.name}</h3>
                <p class="text-gray-500 text-sm mb-3">${student.class}</p>
                <div class="bg-blue-100 text-blue-800 rounded-full px-3 py-1">
                    มาเรียน${periodLabel}: <span class="font-bold">${periodCounts[student.id] || 0}</span> ครั้ง
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- SCANNING LOGIC ---
    toggleScanBtn.addEventListener('click', () => { if (isCameraActive) stopScanning(); else startScanning(); });
    function startScanning() { isCameraActive = true; toggleScanBtn.innerText = 'หยุดสแกน'; toggleScanBtn.classList.remove('bg-blue-600'); toggleScanBtn.classList.add('bg-red-600'); document.getElementById('camera-placeholder').classList.add('hidden'); document.getElementById('video').classList.remove('hidden'); startVideo(); }
    function stopScanning() { isCameraActive = false; if (checkInInterval) clearInterval(checkInInterval); if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop()); video.srcObject = null; const context = canvas.getContext('2d'); context.clearRect(0, 0, canvas.width, canvas.height); toggleScanBtn.innerText = 'เริ่มสแกน'; toggleScanBtn.classList.add('bg-blue-600'); toggleScanBtn.classList.remove('bg-red-600'); document.getElementById('status-indicator').classList.add('hidden'); document.getElementById('video').classList.add('hidden'); document.getElementById('camera-placeholder').classList.remove('hidden'); }
    const startVideo = () => { navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => { video.srcObject = stream; }).catch(err => { Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเข้าถึงกล้องเว็บแคมได้', 'error'); stopScanning(); }); };
    
    // --- APP INITIALIZATION ---
    async function initializeApp() {
        showLoading('กำลังโหลดโมเดล AI...');
        await Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        
        showLoading('กำลังโหลดข้อมูลนักเรียนและสถิติ...');
        const studentsPromise = callGoogleScript('getStudents');
        const attendancePromise = callGoogleScript('getAttendance');
        
        const [studentsResult, attendanceResult] = await Promise.all([studentsPromise, attendancePromise]);

        if (studentsResult) {
            // **FIX:** Expect 5 columns now, including imageData
            studentsData = studentsResult.map(row => ({ id: row[0], name: row[1], class: row[2], faceEncoding: row[3], imageData: row[4] }));
            const labeledFaceDescriptors = studentsData.map(student => {
                if (!student.faceEncoding || !student.faceEncoding.startsWith('[')) return null;
                try {
                    const descriptor = new Float32Array(JSON.parse(student.faceEncoding));
                    return new faceapi.LabeledFaceDescriptors(String(student.id), [descriptor]);
                } catch (e) { return null; }
            }).filter(Boolean);

            if (labeledFaceDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);
                toggleScanBtn.disabled = false;
            } else {
                faceMatcher = null;
                Swal.fire({ title: 'ยังไม่มีข้อมูลใบหน้า', text: 'กรุณาไปที่ "จัดการข้อมูล" เพื่อเพิ่มนักเรียนก่อนเริ่มสแกน', icon: 'info' });
            }
        }
        
        if(attendanceResult) {
            allAttendanceData = attendanceResult.map(row => ({ id: row[0], name: row[1], timestamp: row[2] }));
        }

        hideLoading();
        switchTab('scan');
        dashboardDateInput.valueAsDate = new Date();
    }
    
    // --- FACE RECOGNITION ---
    video.addEventListener('play', () => { 
        const displaySize = { width: video.width, height: video.height };
        faceapi.matchDimensions(canvas, displaySize);
        if (checkInInterval) clearInterval(checkInInterval);
        checkInInterval = setInterval(async () => {
            if (!faceMatcher || isScanningPaused || !isCameraActive) return;
            const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            if (resizedDetections.length === 0) return;
            const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
            results.forEach((result, i) => {
                const box = resizedDetections[i].detection.box;
                const student = studentsData.find(s => String(s.id) === result.label);
                if (student) {
                    new faceapi.draw.DrawBox(box, { label: student.name }).draw(canvas);
                    if (!checkedInToday.has(student.id)) handleSuccessfulScan(student);
                } else {
                    new faceapi.draw.DrawBox(box, { label: 'ไม่รู้จัก', boxColor: 'red' }).draw(canvas);
                }
            });
        }, 700);
    });
    
    async function handleSuccessfulScan(student) {
        checkedInToday.add(student.id);
        isScanningPaused = true;
        speak(`สวัสดีค่ะ ${student.name}`);
        document.getElementById('scan-log').innerHTML = `<div class="p-2 mb-2 bg-green-100 text-green-800 rounded-md font-semibold">[${new Date().toLocaleTimeString('th-TH')}] เช็คชื่อสำเร็จ: ${student.name}</div>` + document.getElementById('scan-log').innerHTML;
        
        const newRecord = { id: student.id, name: student.name, timestamp: new Date().toISOString() };
        allAttendanceData.push(newRecord);
        await callGoogleScript('recordAttendance', { id: student.id, name: student.name });

        setTimeout(() => { isScanningPaused = false; }, 3000);
    }
    
    // --- STUDENT MANAGEMENT ---
    document.getElementById('manage-data-btn').addEventListener('click', async () => { await loadStudentsTable(); document.getElementById('student-list-modal').classList.remove('hidden'); });
    document.getElementById('close-list-modal-btn').addEventListener('click', () => document.getElementById('student-list-modal').classList.add('hidden'));
    document.getElementById('add-student-btn').addEventListener('click', () => openStudentModal());
    document.getElementById('cancel-btn').addEventListener('click', () => document.getElementById('student-modal').classList.add('hidden'));
    function openStudentModal(student = null, rowIndex = null) { 
        const form = document.getElementById('student-form');
        form.reset();
        document.getElementById('student-row-index').value = rowIndex !== null ? rowIndex : '';
        if (student) {
            document.getElementById('modal-title').innerText = 'แก้ไขข้อมูลนักเรียน';
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-id').readOnly = true;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-class').value = student.class;
        } else {
            document.getElementById('modal-title').innerText = 'เพิ่มข้อมูลนักเรียน';
            document.getElementById('student-id').readOnly = false;
        }
        document.getElementById('student-modal').classList.remove('hidden');
    }

    document.getElementById('student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const imageFile = document.getElementById('student-image').files[0];
        const rowIndex = document.getElementById('student-row-index').value;
        if (!rowIndex && !imageFile) { Swal.fire('ข้อผิดพลาด', 'กรุณาอัปโหลดรูปภาพสำหรับนักเรียนใหม่', 'error'); return; }

        showLoading('กำลังประมวลผลใบหน้า...');
        const student = {
            rowIndex: rowIndex,
            id: document.getElementById('student-id').value,
            name: document.getElementById('student-name').value,
            class: document.getElementById('student-class').value,
            faceEncoding: null,
            imageData: null // To store thumbnail
        };
        
        if (imageFile) {
            try {
                const image = await faceapi.bufferToImage(imageFile);
                const detection = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
                if (!detection) throw new Error('ไม่พบใบหน้าในรูปภาพ!');
                student.faceEncoding = JSON.stringify(Array.from(detection.descriptor));

                // **NEW:** Create a thumbnail for display
                const canvasThumb = document.createElement('canvas');
                const ctx = canvasThumb.getContext('2d');
                const MAX_WIDTH = 200; // Small thumbnail size
                const scale = MAX_WIDTH / image.width;
                canvasThumb.width = MAX_WIDTH;
                canvasThumb.height = image.height * scale;
                ctx.drawImage(image, 0, 0, canvasThumb.width, canvasThumb.height);
                student.imageData = canvasThumb.toDataURL('image/jpeg', 0.8); // Compress as JPEG

            } catch(error) {
                hideLoading();
                Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
                return;
            }
        }
        showLoading('กำลังบันทึกข้อมูล...');
        const action = student.rowIndex ? 'updateStudent' : 'addStudent';
        const result = await callGoogleScript(action, student);
        if (result) {
            document.getElementById('student-modal').classList.add('hidden');
            await initializeApp(); 
            await loadStudentsTable();
            Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
        }
        hideLoading();
    });

    async function loadStudentsTable() { 
        showLoading('กำลังโหลดตาราง...');
        const tableBody = document.getElementById('student-table-body');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">กำลังโหลด...</td></tr>';
        const data = await callGoogleScript('getStudents');
        if (data) {
            // Data now has 5 columns, but we only need 3 for this table
            const tableStudents = data.map(row => ({ id: row[0], name: row[1], class: row[2] }));
            tableBody.innerHTML = '';
            tableStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `<td class="p-3">${student.id}</td><td class="p-3">${student.name}</td><td class="p-3">${student.class}</td><td class="p-3"><button class="edit-btn bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm" data-index="${index}">แก้ไข</button><button class="delete-btn bg-red-100 text-red-700 px-3 py-1 rounded text-sm ml-2" data-rowindex="${index + 2}">ลบ</button></td>`;
                tableBody.appendChild(row);
            });
            tableBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openStudentModal(tableStudents[e.target.dataset.index], parseInt(e.target.dataset.index) + 2)));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                Swal.fire({ title: 'ต้องการลบข้อมูลนี้?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!'}).then(async (result) => {
                    if (result.isConfirmed) {
                        showLoading('กำลังลบ...');
                        await callGoogleScript('deleteStudent', { rowIndex: e.target.dataset.rowindex });
                        await initializeApp();
                        await loadStudentsTable();
                        hideLoading();
                    }
                });
            }));
        }
        hideLoading();
    }
    
    // --- INITIAL LOAD ---
    const configModal = document.getElementById('config-modal');
    document.getElementById('save-config-btn').addEventListener('click', () => { const url = document.getElementById('web-app-url-input').value.trim(); if (url) { localStorage.setItem('webAppUrl', url); checkConfig(); } });
    document.getElementById('reset-config-btn').addEventListener('click', () => { localStorage.removeItem('webAppUrl'); location.reload(); });
    const checkConfig = () => { WEB_APP_URL = localStorage.getItem('webAppUrl'); if (!WEB_APP_URL) configModal.classList.remove('hidden'); else { configModal.classList.add('hidden'); appContainer.classList.remove('hidden'); initializeApp(); } };
    checkConfig();
});
</script>
</body>
</html>

